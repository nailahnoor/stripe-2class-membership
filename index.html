<script>
const stripe = Stripe("pk_test_51QG3MjAXY9hpMKCtZnFYTiRFjCHqD8jjci5n8fCNQ4OfxKrAnYBGuk7Iq3jDE1NGTiT8SBCIl70RQ2h2HCavPDbW00oAxvTmIf");
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxskp60gMiBpfy_KXgdXqoiAU6VGGbXGoD_s-Gbhp5mrHPV_C7VMCaX-a7V1GKAPp4v/exec";

let elements;
let paymentElement;
let clientSecret;

// 1️⃣ Get client_secret as soon as page loads
async function fetchClientSecret() {
  const emailInput = document.getElementById("email").value || "test@example.com"; // temp
  const res = await fetch(APPS_SCRIPT_URL, {
    method: "POST",
    body: JSON.stringify({ email: emailInput })
  });
  const data = await res.json();
  if (!data.success) {
    document.getElementById("error-message").textContent = data.error || "Error fetching client secret";
    return;
  }
  clientSecret = data.client_secret;

  // 2️⃣ Mount Payment Element
  elements = stripe.elements({ clientSecret });
  paymentElement = elements.create("payment");
  paymentElement.mount("#payment-element");
}

// 3️⃣ Handle form submit
document.getElementById("payment-form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const email = document.getElementById("email").value;

  const { error } = await stripe.confirmPayment({
    elements,
    confirmParams: { return_url: window.location.href },
  });

  if (error) {
    document.getElementById("error-message").textContent = error.message;
  }
});

// 4️⃣ Initialize on page load
window.addEventListener("DOMContentLoaded", fetchClientSecret);
</script>
