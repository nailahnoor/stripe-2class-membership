<script>
  const stripe = Stripe("pk_test_51QG3MjAXY9hpMKCtZnFYTiRFjCHqD8jjci5n8fCNQ4OfxKrAnYBGuk7Iq3jDE1NGTiT8SBCIl70RQ2h2HCavPDbW00oAxvTmIf");
  const BACKEND_URL = "https://stripe-2class-membership.vercel.app/api/create-subscription";

  const form = document.getElementById("payment-form");
  const emailInput = document.getElementById("email");
  const errorDiv = document.getElementById("error-message");

  let elements;

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    errorDiv.textContent = "";

    try {
      // 1️⃣ Create subscription + PaymentIntent
      const res = await fetch(BACKEND_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email: emailInput.value }),
      });

      const data = await res.json();

      if (!data.clientSecret) {
        throw new Error(data.error || "No client secret returned");
      }

      // 2️⃣ Mount Payment Element
      elements = stripe.elements({ clientSecret: data.clientSecret });
      const paymentElement = elements.create("payment");
      paymentElement.mount("#payment-element");

      // 3️⃣ Confirm payment
      form.onsubmit = async (event) => {
        event.preventDefault();

        const { error } = await stripe.confirmPayment({
          elements,
          confirmParams: {
            return_url: window.location.href,
          },
        });

        if (error) {
          errorDiv.textContent = error.message;
        }
      };

    } catch (err) {
      errorDiv.textContent = err.message;
    }
  });
</script>
